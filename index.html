<!DOCTYPE html>
<html lang="et">
<head>
<title>Lambanaljad</title>
<link href="https://fonts.googleapis.com/css2?family=Comic+Relief&amp;display=swap" rel="stylesheet">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
<style>
.peidus {
  display: none;
}
#yks, #kaks, #kolm {margin-top: 100px; height: calc(100vh - 50px); width: 100%; overflow-y: auto;word-wrap: break-word;}
#uleval {position: fixed; top:0; left: 0; width: 100%; background-image: linear-gradient(lightblue, lightgray);height: 30px; transition: height 1s; overflow: hidden;}
html {
scroll-behavior: smooth;
}
i {color: darkgray; display: none;}
a, a:link, a:visited {color: blue;}
.menuu { float: right; margin-right: 20px;  }
body {font-family: "Comic Relief", system-ui; background-color: lightgray; overflow-y: hidden; font-size: 15px;}
#suur {height: 10vh;}
#vaike {height: 20px;}
button {border: none; font-family: "Comic Relief", system-ui; border-radius: 5px; padding: 5px; color: black; background: linear-gradient(lightgreen, lightblue); z-index: 10}
input {width: 35%; font-family: "Comic Relief", system-ui; border-image: linear-gradient(lightgreen, lightblue) 30 round; border-width: 5px; border-radius: 5px}
</style>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
<span id="uleval"><img src="lambanaljad_logo.svg" id="vaike"> lambanaljad <a class="menuu" href="#kolm">täiusta</a> <a class="menuu" href="#kaks">naljad</a> <a class="menuu" href="#yks">info</a>
</span>
<div id="yks"><br><br>Teretulemast lehele lambanaljad!<br>See leht on väga-väga uus ja selle tegi <a href="https://valeNimi4.github.io">valeNimi4</a><br>(Praegu) pisikese naljakataloogi uurimiseks mine <a href="#kaks">naljadesse</a> <br>Kui tahad nalja lisada
mine <a href="#kolm">täiustamisse</a> ja logi sisse/tee konto ning saadki nalja lisada.<br>
Hea lambanali ei solva ja on legaalne. Hea lambanaljataja on lugupidav, inimene (mitte robot) ja viisakas
<br>
Limiidid ühele kontole:
	2 sisselogimist tunnis
	120 nalja tunnis
	nalja pikkus: 3-200 tähemärki
Võib koguda neid andmeid: kellaeg, nali, email, supabase kasutaja number. Leht kasutab küpsiseid.<br>
Sinu andmeid ei jagata kolmandatele osapooltele.<br>
Nalju kuvatakse nii (kui detailid pole peidetud):<br>
<i style="display: inline;">id</i>Nalja sisu<i style="display: inline;">aeg</i></div>
<div id="kaks"><br><br></div>
<div id="kolm"><br><br>
<div id="l">
Konto loomiseks või sisse logimiseks sisestage oma email. Sinu emailile saadetakse ühekordne sisselogimise kood, millega saad sisse logida või konto luua<br>
<input id="e" placeholder="email">
<button id="auth1">SISENE</button>
</div>
<div id="o" class="peidus">
Teile saadeti emailile kood. Palun sisestage see siia:
<input id="kood" placeholder="kood">
<button id="auth2">JÄTKA</button>
</div>
<div id="f" class="peidus">
  <button id="v">Logi välja</button><br>
  <input id="t" placeholder="nali">
  <button id="lisa">LISA</button><br><br>
<button onclick="document.querySelectorAll(`i`).forEach(el => {el.style.display = `inline`})">Kuva detailid</button><br><div id="MINU"></div></div>
<!-- <button  onclick="const elmnt = document.getElementsByTagName('i');for (let i = 0; i < elmnt.length; i++) {elmnt[i].style.visibility = 'visible';}">Näita üksikasju</button> -->
<script type="module">

import { createClient } from "https://esm.sh/@supabase/supabase-js"
const s = createClient("https://iqrrffhjxakqvlshonbr.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlxcnJmZmhqeGFrcXZsc2hvbmJyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzNTAxMzgsImV4cCI6MjA3NTkyNjEzOH0.kqOJ9Ui08Z8dXLGSE3dKXRl436_OKkqli3hbTrQAufA")
if (!location.hash) {location.hash = "#yks"}
var info;
var viga;
var info2;
var error;
var data;
const ntdetaile = '<button onclick="document.querySelectorAll(`i`).forEach(el => {el.style.display = `inline`})">Kuva detailid</button><br>';
({data, error} = await s.auth.getSession());
s.auth.onAuthStateChange((event, session) => {
  if (event === 'SIGNED_IN' && session) {
	console.log("SISSELOGITUD!");
	o.classList.add("peidus");
	f.classList.remove("peidus");
  }
});
if (error) {alert(error.message)} else {if(data.session) { l.classList.add("peidus"); f.classList.remove("peidus");}}
auth1.onclick = async () => {
try {auth1.disabled = true;
await s.auth.signInWithOtp({
  email: e.value})
 l.classList.add("peidus"); o.classList.remove("peidus");} 
catch (error) {
alert(error.message)}}
v.onclick = async () => {info = await s.auth.signOut(); if (info.error) {alert(info.error.message)} else {location.reload()}}
auth2.onclick = async() => {
  const { adata, aerror } = await s.auth.verifyOtp({
  email: e.value,
  token: kood.value,
  type: 'email',
}); if (aerror) {alert("ERROR\n"+aerror.message)} else if (adata.session) {o.classList.add("peidus"); f.classList.remove("peidus"); load()}}
lisa.onclick = async () => {
try {
  const { data:{user} } = await s.auth.getUser()
  info = await s.from("lambanaljad_eivaata").insert({ user_id:user.id, text: t.value });
  if (info.error) {throw info.error}
  t.value = ""
  load()
}catch (err) {
alert("ERROR\n"+err.message)}}
const kustuta= async (k_id) { if (confirm("Kas tahate tõesti selle NALJA KUSTUTADA?") {info = await s.from("lambanaljad_eivaata").delete().eq("id", k_id); if (info.error) {alert("ERROR\n"+info.error.message)} else {load()}}}
otsing.oninput = async () => {load()}
const load = async () => {try{
const kiri = "";
  ({data: info, error: viga} = await s.from("lambanaljad").select("*").order('random()')).ilike("text", otsing.value);
  ({data: info2, error: viga} = await s.from("lambanaljad_eivaata").select("*").order('random()'));
    if (viga) {throw viga}
  kaks.innerHTML = '<br><br><input id="otsing"><br>' + ntdetaile + info.map(r=>`<i>${r.id}</i>${r.text.replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;").replaceAll('"', "&quot;").replaceAll("'", "&#39;")}<i>${r.created_at}</i><br><br>`).join("");
  MINU.innerHTML = info2.map(r=>`<a onclick="kustuta('${r.id}')><i>${r.id}</i>${r.text.replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;").replaceAll('"', "&quot;").replaceAll("'", "&#39;")}<i>${r.created_at}</i></a><br><br>`).join("");
 } catch (error) {alert(info.error.message)}}
load()
</script>
</body>
</html>

